# ü§ñ Notification Bot - AI Chatbot API Backend

[![FastAPI](https://img.shields.io/badge/FastAPI-005571?style=for-the-badge&logo=fastapi)](https://fastapi.tiangolo.com/)
[![MongoDB](https://img.shields.io/badge/MongoDB-4EA94B?style=for-the-badge&logo=mongodb&logoColor=white)](https://www.mongodb.com/)
[![Redis](https://img.shields.io/badge/redis-%23DD0031.svg?style=for-the-badge&logo=redis&logoColor=white)](https://redis.io/)
[![Google Gemini](https://img.shields.io/badge/Google%20Gemini-4285F4?style=for-the-badge&logo=google&logoColor=white)](https://ai.google.dev/)

## üìã T·ªïng quan

Notification Bot l√† m·ªôt h·ªá th·ªëng chatbot API backend ho√†n ch·ªânh, c√≥ th·ªÉ import v√† th√™m kh√°ch h√†ng, t·∫°o s·ª± ki·ªán th√¥ng b√°o g·ª≠i ƒë·∫øn user, sau ƒë√≥ n·∫øu user tr·∫£ l·ªùi qua k√™nh chat, AI s·∫Ω tr·∫£ l·ªùi user theo context v√† memory long-short term

### ‚ú® T√≠nh nƒÉng ch√≠nh

- üë• **Qu·∫£n l√Ω kh√°ch h√†ng** - CRUD operations + CSV import t·ª± ƒë·ªông
- üìß **H·ªá th·ªëng th√¥ng b√°o** - Chat notifications v·ªõi template system
- ‚ö° **Background Tasks** - TaskIQ cho x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô
- üîê **JWT Authentication** - B·∫£o m·∫≠t API endpoints
- üìä **Task Monitoring** - Dashboard theo d√µi tasks real-time
- üåê **RESTful API** - Swagger/OpenAPI documentation
- ü§ñ **AI Chatbot th√¥ng minh** - S·ª≠ d·ª•ng Google Gemini v·ªõi Langchain
- üß† **Memory Management** - Redis (short-term) + MongoDB (long-term)


## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

```mermaid
graph TB
    A[FastAPI Server] --> B[JWT Auth]
    A --> C[Customer API]
    A --> D[Message API]
    A --> E[Notification API]
    A --> F[Task API]
    
    C --> G[MongoDB]
    D --> H[Google Gemini AI]
    D --> I[Redis Cache]
    D --> G
    
    E --> J[TaskIQ Worker]
    F --> J
    J --> K[Chat Service]
    J --> L[CSV Processing]
    
    H --> M[Langchain]
    I --> N[Short-term Memory]
    G --> O[Long-term Memory]
```

## üõ†Ô∏è Tech Stack

### Backend Framework
- **FastAPI** - Modern, fast web framework cho Python
- **Uvicorn** - ASGI server v·ªõi performance cao
- **Pydantic** - Data validation v√† settings management

### Database & Cache
- **MongoDB** - NoSQL database v·ªõi umongo ODM
- **Redis** - In-memory cache v√† message broker
- **Motor** - Async MongoDB driver

### GenAI
- **Google Gemini** - Large Language Model
- **Langchain** - AI framework cho chat applications
- **Google GenerativeAI** - Python SDK cho Gemini

### Task Queue & Background Processing
- **TaskIQ** - Modern task queue cho Python
- **TaskIQ-Redis** - Redis broker cho TaskIQ

### Authentication & Security
- **Python-JOSE** - JWT token handling
- **Passlib** - Password hashing v·ªõi bcrypt
- **CORS Middleware** - Cross-origin resource sharing

### Data Processing & Chat
- **Pandas** - CSV processing v√† data manipulation
- **aiosmtplib** - Async SMTP client
- **FastAPI-Mail** - Chat template system
- **Jinja2** - Template engine

## üì¶ C√†i ƒë·∫∑t v√† Setup (Docker)

C√°ch nhanh nh·∫•t v√† ƒë∆∞·ª£c khuy·∫øn kh√≠ch ƒë·ªÉ ch·∫°y d·ª± √°n n√†y l√† s·ª≠ d·ª•ng Docker v√† Docker Compose. To√†n b·ªô h·ªá th·ªëng (API, Worker, Database, Cache) s·∫Ω ƒë∆∞·ª£c kh·ªüi ƒë·ªông ch·ªâ v·ªõi m·ªôt v√†i l·ªánh ƒë∆°n gi·∫£n.

### 1. Y√™u c·∫ßu h·ªá th·ªëng
- Docker
- Docker Compose
- `make` (t√πy ch·ªçn, ƒë·ªÉ s·ª≠ d·ª•ng c√°c l·ªánh t·∫Øt)

### 2. Clone repository
```bash
git clone <repository-url>
cd notification_bot
```

### 3. C·∫•u h√¨nh m√¥i tr∆∞·ªùng
C·∫ßn t·∫°o m·ªôt file `.env` trong th∆∞ m·ª•c `notification/` ƒë·ªÉ c·∫•u h√¨nh c√°c bi·∫øn m√¥i tr∆∞·ªùng.

```bash
# T·ª´ th∆∞ m·ª•c g·ªëc c·ªßa project (notification_bot)
cp notification/env.example notification/.env
```

Sau ƒë√≥, m·ªü file `notification/.env` v√† ƒëi·ªÅn `GOOGLE_API_KEY` c·ªßa . C√°c bi·∫øn kh√°c ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh s·∫µn ƒë·ªÉ ho·∫°t ƒë·ªông v·ªõi Docker Compose.

```env
# notification/.env

# Google Gemini API (B·∫ÆT BU·ªòC)
GOOGLE_API_KEY=your-google-api-key-here

# C√°c bi·∫øn kh√°c c√≥ th·ªÉ gi·ªØ nguy√™n khi ch·∫°y v·ªõi Docker
# ...
```

### 4. Kh·ªüi ƒë·ªông h·ªá th·ªëng
S·ª≠ d·ª•ng `make` ƒë·ªÉ kh·ªüi ƒë·ªông t·∫•t c·∫£ c√°c service. L·ªánh n√†y s·∫Ω t·ª± ƒë·ªông build image v√† ch·∫°y c√°c container ·ªü ch·∫ø ƒë·ªô n·ªÅn.

```bash
make up
```

N·∫øu kh√¥ng c√≥ `make`,  c√≥ th·ªÉ d√πng l·ªánh `docker-compose` tr·ª±c ti·∫øp:
```bash
docker-compose up -d --build
```

### 5. Ki·ªÉm tra tr·∫°ng th√°i
Sau khi kh·ªüi ƒë·ªông, c√≥ th·ªÉ ki·ªÉm tra tr·∫°ng th√°i c·ªßa c√°c container:
```bash
docker-compose ps
```

C√°c service `mongo`, `redis`, `app`, v√† `worker` s·∫Ω ch·∫°y.

### 6. Truy c·∫≠p ·ª©ng d·ª•ng
- **API Documentation (Swagger UI)**: [http://localhost:8000/docs](http://localhost:8000/docs)
- **Health Check**: [http://localhost:8000/health](http://localhost:8000/health)

### C√°c l·ªánh `make` h·ªØu √≠ch kh√°c
- `make logs`: Xem log t·ª´ t·∫•t c·∫£ c√°c service.
- `make logs-app`: Ch·ªâ xem log c·ªßa API server.
- `make logs-worker`: Ch·ªâ xem log c·ªßa TaskIQ worker.
- `make down`: D·ª´ng t·∫•t c·∫£ c√°c service.
- `make clean`: D·ª´ng v√† x√≥a to√†n b·ªô container, network v√† volume.
- `make shell`: Truy c·∫≠p v√†o shell c·ªßa container `app` ƒë·ªÉ g·ª° l·ªói ho·∫∑c ch·∫°y l·ªánh.

## üöÄ API Documentation

### Authentication Endpoints
| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/auth/login` | ƒêƒÉng nh·∫≠p user | ‚ùå |
| GET | `/auth/me` | Th√¥ng tin user hi·ªán t·∫°i | ‚úÖ |
| POST | `/auth/register` | ƒêƒÉng k√Ω user m·ªõi | ‚ùå |

### Customer Management
| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/customers` | Danh s√°ch kh√°ch h√†ng (c√≥ pagination) | ‚úÖ |
| POST | `/customers` | T·∫°o kh√°ch h√†ng m·ªõi | ‚úÖ |
| GET | `/customers/{id}` | Chi ti·∫øt kh√°ch h√†ng | ‚úÖ |
| PUT | `/customers/{id}` | C·∫≠p nh·∫≠t kh√°ch h√†ng | ‚úÖ |
| DELETE | `/customers/{id}` | X√≥a kh√°ch h√†ng | ‚úÖ |
| POST | `/customers/import` | Import CSV v·ªõi TaskIQ | ‚úÖ |

### AI Chatbot
| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/messages/send` | G·ª≠i tin nh·∫Øn cho AI | ‚úÖ |
| GET | `/messages/history` | L·ªãch s·ª≠ chat theo session | ‚úÖ |
| DELETE | `/messages/history/{session_id}` | X√≥a l·ªãch s·ª≠ chat | ‚úÖ |
| GET | `/messages/memory/stats` | Th·ªëng k√™ memory usage | ‚úÖ |

### Notification System
| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/notifications/config` | T·∫°o notification template | ‚úÖ |
| GET | `/notifications/config` | Danh s√°ch templates | ‚úÖ |
| PUT | `/notifications/config/{id}` | C·∫≠p nh·∫≠t template | ‚úÖ |
| DELETE | `/notifications/config/{id}` | X√≥a template | ‚úÖ |
| POST | `/notifications/send` | G·ª≠i notification v·ªõi TaskIQ | ‚úÖ |
| GET | `/notifications/history` | L·ªãch s·ª≠ notifications | ‚úÖ |
| GET | `/notifications/stats` | Th·ªëng k√™ notifications | ‚úÖ |

### Task Management
| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/tasks` | Danh s√°ch tasks (c√≥ filter) | ‚úÖ |
| GET | `/tasks/{job_id}` | Chi ti·∫øt task | ‚úÖ |
| POST | `/tasks/{job_id}/cancel` | H·ªßy task ƒëang ch·∫°y | ‚úÖ |
| DELETE | `/tasks/{job_id}` | X√≥a task record | ‚úÖ |
| GET | `/tasks/stats/overview` | Th·ªëng k√™ t·ªïng quan | ‚úÖ |
| GET | `/tasks/stats/recent` | Th·ªëng k√™ tasks g·∫ßn ƒë√¢y | ‚úÖ |

## ü§ñ AI Chatbot System

### T√≠nh nƒÉng AI
- **Context Awareness**: Bot nh·ªõ th√¥ng tin kh√°ch h√†ng v√† l·ªãch s·ª≠ h·ªôi tho·∫°i
- **Vietnamese Support**: ƒê∆∞·ª£c t·ªëi ∆∞u cho ti·∫øng Vi·ªát
- **Professional Tone**: Gi·ªçng ƒëi·ªáu chuy√™n nghi·ªáp
- **Notification Integration**: T·ª± ƒë·ªông reference notifications trong chat
- **Memory Management**: K·∫øt h·ª£p short-term (Redis) v√† long-term (MongoDB)

### System Prompt
Bot ƒë∆∞·ª£c c·∫•u h√¨nh v·ªõi personality chuy√™n nghi·ªáp trong `prompts/system_prompt.py`:
- Tr·ª£ l√Ω kh√°ch h√†ng th√¢n thi·ªán
- Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát
- H·ªó tr·ª£ ƒë·∫∑t h√†ng, thanh to√°n, ch√≠nh s√°ch
- T√≠ch h·ª£p th√¥ng b√°o v√†o cu·ªôc h·ªôi tho·∫°i

### Memory Architecture
```python
# Short-term Memory (Redis) - 30 ph√∫t
- Conversation context
- Recent customer interactions
- Temporary session data

# Long-term Memory (MongoDB) - Vƒ©nh vi·ªÖn
- Customer profiles
- Chat history
- Notification records
- Learning patterns
```

## üìß Notification System

### Template System
- **Dynamic Variables**: `{customer_name}`, `{customer_email}`, `{company}`
- **Jinja2 Templates**: Advanced templating v·ªõi logic
- **Multi-channel**: Chat
- **Batch Processing**: G·ª≠i h√†ng lo·∫°t v·ªõi TaskIQ

### Notification Flow
```mermaid
sequenceDiagram
    participant Admin
    participant API
    participant TaskIQ
    participant AI Bot
    participant Customer
    
    Admin->>API: POST /notifications/send
    API->>TaskIQ: Queue notification task
    TaskIQ->>TaskIQ: Process template
    TaskIQ->>Customer: Send Chat
    TaskIQ->>AI Bot: Inject into chat context
    Customer->>AI Bot: Ask about notification
    AI Bot->>Customer: Reference notification content
```

## ‚ö° TaskIQ Background Processing

### Task Types
1. **CSV Import Processing** (`import_customers.py`)
   - Parse v√† validate CSV files
   - Batch insert customers
   - Progress tracking
   - Error reporting

2. **Chat Notification Sending** (`send_notification.py`)
   - Template processing
   - Batch Chat sending
   - Delivery tracking
   - Retry mechanism

### Task Monitoring
- **Real-time Progress**: WebSocket updates
- **Status Tracking**: pending ‚Üí running ‚Üí completed/failed
- **Error Handling**: Detailed error logs
- **Performance Metrics**: Execution time, success rate
- **Task Cancellation**: Stop running tasks

## üìÅ C·∫•u tr√∫c Project

```
notification/
‚îú‚îÄ‚îÄ üìÅ api/                     # API route handlers
‚îÇ   ‚îú‚îÄ‚îÄ üîê auth.py             # JWT authentication
‚îÇ   ‚îú‚îÄ‚îÄ üë• customer.py         # Customer CRUD + CSV import
‚îÇ   ‚îú‚îÄ‚îÄ üí¨ message.py          # AI chatbot messaging
‚îÇ   ‚îú‚îÄ‚îÄ üìß notification.py     # Notification management
‚îÇ   ‚îî‚îÄ‚îÄ ‚ö° tasks.py            # Task monitoring
‚îú‚îÄ‚îÄ üìÅ config/                  # Configuration modules
‚îÇ   ‚îú‚îÄ‚îÄ ‚öôÔ∏è settings.py         # Pydantic settings
‚îÇ   ‚îî‚îÄ‚îÄ üóÑÔ∏è database.py         # DB connection setup
‚îú‚îÄ‚îÄ üìÅ models/                  # Database models (umongo)
‚îÇ   ‚îú‚îÄ‚îÄ üë§ user.py             # User authentication
‚îÇ   ‚îú‚îÄ‚îÄ üë• customer.py         # Customer data model
‚îÇ   ‚îú‚îÄ‚îÄ üí¨ chat.py             # Chat sessions & messages
‚îÇ   ‚îú‚îÄ‚îÄ üìß notification.py     # Notification templates
‚îÇ   ‚îî‚îÄ‚îÄ ‚ö° task.py             # TaskIQ job tracking
‚îú‚îÄ‚îÄ üìÅ services/                # Business logic layer
‚îÇ   ‚îú‚îÄ‚îÄ üîê auth.py             # JWT + password hashing
‚îÇ   ‚îú‚îÄ‚îÄ ü§ñ ai_chatbot.py       # Google Gemini integration
‚îÇ   ‚îî‚îÄ‚îÄ üß† memory_manager.py   # Redis + MongoDB memory
‚îú‚îÄ‚îÄ üìÅ tasks/                   # TaskIQ background tasks
‚îÇ   ‚îú‚îÄ‚îÄ üìä import_customers.py # CSV processing
‚îÇ   ‚îî‚îÄ‚îÄ üìß send_notification.py# Chat sending
‚îú‚îÄ‚îÄ üìÅ utils/                   # Utility functions
‚îÇ   ‚îî‚îÄ‚îÄ ‚úÖ validators.py       # Data validation helpers
‚îú‚îÄ‚îÄ üìÅ prompts/                 # AI prompt templates
‚îÇ   ‚îî‚îÄ‚îÄ ü§ñ system_prompt.py    # FTEL chatbot personality
‚îú‚îÄ‚îÄ üìÅ uploads/                 # File upload directory
‚îú‚îÄ‚îÄ üöÄ main.py                 # FastAPI application
‚îú‚îÄ‚îÄ ‚ö° worker.py               # TaskIQ worker process
‚îú‚îÄ‚îÄ üìã requirements.txt        # Python dependencies
‚îú‚îÄ‚îÄ üîß env.example             # Environment template
‚îî‚îÄ‚îÄ üìö README.md               # Documentation
```

## üîß Development

### Local Development
```bash
# Hot reload development server
uvicorn main:app --reload --host 0.0.0.0 --port 8000

# Run TaskIQ worker v·ªõi debug
python worker.py

# Run tests
pytest tests/ -v

# Code formatting
black .
isort .
```

### Environment Variables
```env
# App Configuration
DEBUG=true
APP_NAME="Chatbot API Backend"
APP_VERSION="1.0.0"
HOST=0.0.0.0
PORT=8000

# Security
SECRET_KEY=your-secret-key-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# Database
MONGODB_URL=mongodb://admin:password123@localhost:27017
MONGODB_DATABASE=chatbot_db

# Redis & TaskIQ
REDIS_URL=redis://localhost:6379
REDIS_DB=0
TASKIQ_BROKER_URL=redis://localhost:6379/1
TASKIQ_RESULT_BACKEND_URL=redis://localhost:6379/2

# AI Configuration
GOOGLE_API_KEY=your-google-api-key
GEMINI_MODEL=gemini-1.5-flash

# File Upload
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760  # 10MB

# Memory Settings
SHORT_TERM_MEMORY_TTL=1800  # 30 minutes
MAX_CONVERSATION_HISTORY=50
```

## üìä Monitoring & Analytics

### Health Checks
```bash
# Basic health check
curl http://localhost:8000/health

# Database connectivity
curl http://localhost:8000/health/db

# Redis connectivity
curl http://localhost:8000/health/redis
```

### API Documentation
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **OpenAPI JSON**: http://localhost:8000/openapi.json

### Performance Monitoring
- Task execution metrics
- Memory usage statistics
- API response times
- Error rate tracking
- Database query performance

## üîí Security Features

- **JWT Authentication**: Secure token-based auth
- **Password Hashing**: bcrypt v·ªõi salt
- **CORS Protection**: Configurable origins
- **Input Validation**: Pydantic models
- **File Upload Security**: Type v√† size validation
- **Rate Limiting**: API endpoint protection
- **SQL Injection Prevention**: NoSQL v·ªõi umongo

## üê≥ Docker Deployment (Coming Soon)

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - mongo
      - redis
    environment:
      - MONGODB_URL=mongodb://admin:password123@mongo:27017
      - REDIS_URL=redis://redis:6379
      # ... other env vars

  worker:
    build: .
    command: python worker.py
    depends_on:
      - redis
    environment:
      - TASKIQ_BROKER_URL=redis://redis:6379/1
      # ... other env vars

  mongo:
    image: mongo:latest
    # ... config

  redis:
    image: redis:7-alpine
    # ... config
```

## ü§ù Contributing

Contributions are welcome! Please follow these steps:
1. Fork the repository.
2. Create a new feature branch (`git checkout -b feature/your-feature`).
3. Commit your changes (`git commit -m 'Add some feature'`).
4. Push to the branch (`git push origin feature/your-feature`).
5. Open a Pull Request.

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details. 